### ========================================
### PRUEBAS DEL REFACTOR - Columnas de Fecha/Hora
### ========================================
### Verificar que horaIngreso, fechaIngreso, horaSalida, fechaSalida
### se guarden en COLUMNAS y no en JSON
### ========================================

@baseUrl = http://localhost:5170
@token = TU_TOKEN_JWT_AQUI

### ========================================
### 1. LOGIN (obtener token primero)
### ========================================
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "usuario": "admin",
  "password": "admin123"
}

### COPIA EL TOKEN DE ARRIBA Y PEGALO EN @token


### ========================================
### 2. POST - Registrar INGRESO de Proveedor
### ========================================
### VERIFICA DESPUÉS EN LA BD:
### - HoraIngreso debe tener valor en la COLUMNA
### - FechaIngreso debe tener valor en la COLUMNA
### - DatosJSON NO debe tener horaIngreso ni fechaIngreso
POST {{baseUrl}}/api/proveedor
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "dni": "12345678",
  "nombres": "Juan Carlos",
  "apellidos": "Pérez López",
  "procedencia": "Empresa ABC SAC",
  "destino": "Gerencia General",
  "horaIngreso": "2026-02-09T08:30:00",
  "observacion": "Reunión programada"
}

### GUARDA EL "salidaId" DE LA RESPUESTA PARA EL SIGUIENTE TEST


### ========================================
### 3. PUT - Registrar SALIDA de Proveedor
### ========================================
### REEMPLAZA {id} con el salidaId del paso anterior
### VERIFICA DESPUÉS EN LA BD:
### - HoraSalida debe tener valor en la COLUMNA
### - FechaSalida debe tener valor en la COLUMNA
### - DatosJSON NO debe tener horaSalida ni fechaSalida
PUT {{baseUrl}}/api/proveedor/1/salida
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "horaSalida": "2026-02-09T17:45:00",
  "observacion": "Salida normal"
}


### ========================================
### 4. VERIFICACIÓN EN SQL SERVER
### ========================================
### Ejecuta en SQL Server Management Studio:
###
### USE ControlAccesosDB;
### GO
###
### SELECT TOP 5
###     Id,
###     TipoSalida,
###     HoraIngreso,      -- DEBE TENER VALOR
###     FechaIngreso,     -- DEBE TENER VALOR
###     HoraSalida,       -- DEBE TENER VALOR después del PUT
###     FechaSalida,      -- DEBE TENER VALOR después del PUT
###     DatosJSON         -- NO debe contener horaIngreso/fechaIngreso/horaSalida/fechaSalida
### FROM SalidasDetalle
### WHERE TipoSalida = 'Proveedor'
### ORDER BY FechaCreacion DESC;
### GO


### ========================================
### 5. VERIFICAR COMPATIBILIDAD (Datos antiguos)
### ========================================
### Si tienes registros ANTIGUOS (antes del refactor),
### las columnas estarán en NULL pero el JSON tendrá los datos.
### Los métodos helper del servicio leerán del JSON automáticamente.
###
### Ejecuta en SQL:
###
### SELECT TOP 5
###     Id,
###     COALESCE(HoraIngreso, JSON_VALUE(DatosJSON, '$.horaIngreso')) AS HoraIngresoFinal,
###     COALESCE(FechaIngreso, JSON_VALUE(DatosJSON, '$.fechaIngreso')) AS FechaIngresoFinal,
###     DatosJSON
### FROM SalidasDetalle
### WHERE TipoSalida = 'Proveedor'
### ORDER BY FechaCreacion ASC;
### GO
